<% SWITCH cmd %>
<% CASE 'USER_NOT_FOUND' %>
{
    "sendMessage": {
        "text": "üîê <b>–ë–æ—Ç –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ VPN –∫–ª—é—á–∏–∫–æ–≤</b>",
        "reply_markup": {
            "inline_keyboard": [
                [
                    {
                        "text": "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å...",
                        "callback_data": "/register {{ args.1 }}"
                    }
                ]
            ]
        }
    }
}
<% CASE '/register' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "shmRegister": {
        "partner_id": "{{ args.0 }}",
        "callback_data": "/pricelist",
        "error": "–û–®–ò–ë–ö–ê: –õ–æ–≥–∏–Ω {{ message.chat.username }} –∏–ª–∏ chat_id {{ message.chat.id }} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    }
}
<% CASE ['/start', '/menu', '–õ—É—á—à–µ–µ –ú–µ–Ω—é'] %>
{{ IF cmd != '/start' }}
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{{ END }}
{
    "sendMessage": {
        "text":"–ú–µ–Ω—é",
        "parse_mode": "HTML",
        "reply_markup": {
            "keyboard": [
                [
                    {"text": "–ú–µ–Ω—é"}
                ]
            ],
            "one_time_keyboard": false,
            "resize_keyboard": true
        }
    }
},
{
    "sendMessage": {
        "text": "–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º–∏ VPN –∫–ª—é—á–∞–º–∏",
        "reply_markup": {
            "inline_keyboard": [
                [
                    {
                        "text": "üí∞ –ë–∞–ª–∞–Ω—Å",
                        "callback_data": "/balance"
                    }
                ],
                [
                    {
                        "text": "üóù –°–ø–∏—Å–æ–∫ VPN –∫–ª—é—á–µ–π",
                        "callback_data": "/list"
                    }
                ],
                [
                    {
                        "text": "ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞",
                        "callback_data": "/referrals"
                    }
                ],
                [
                    {
                        "text": "üóì –ü–æ–º–æ—â—å",
                        "callback_data": "/help"
                    }
                ]
            ]
        }
    }
}
<% CASE '/balance' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "sendMessage": {
        "text": "üí∞ <b>–ë–∞–ª–∞–Ω—Å</b>: {{ user.balance }}\n\n–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø–ª–∞—Ç–∏—Ç—å: <b>{{ user.pays.forecast.total }}</b>",
        "reply_markup" : {
            "inline_keyboard": [
                [
                    {
                        "text": "‚úö –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å",
                        "url": "https://yoomoney.ru/quickpay/shop-widget?writer=seller&targets=%D0%9E%D0%BF%D0%BB%D0%B0%D1%82%D0%B0%20%D0%BF%D0%BE%20%D0%B4%D0%BE%D0%B3%D0%BE%D0%B2%D0%BE%D1%80%D1%83%20{{ user.id }}&targets-hint=&default-sum={{ user.pays.forecast.total }}&label={{ user.id }}&button-text=12&payment-type-choice=on&hint=&successURL=&quickpay=shop&account={{ config.pay_systems.yoomoney.account }}"
                    }
                ],
                [
                    {
                        "text": "‚ò∞ –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π",
                        "callback_data": "/pays"
                    }
                ],
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/menu"
                    }
                ]
            ]
        }
    }
}
<% CASE '/list' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "sendMessage": {
        "text": "üîë  –°–ø–∏—Å–æ–∫ VPN –∫–ª—é—á–µ–π",
        "reply_markup" : {
            "inline_keyboard": [
                {{ FOR item IN ref( user.services.list_for_api( 'category', 'vpn-%' ) ) }}
                {{ SWITCH item.status }}
                  {{ CASE 'ACTIVE' }}
                  {{ icon = '‚úÖ' }}
                  {{ status = '–†–∞–±–æ—Ç–∞–µ—Ç' }}
                  {{ CASE 'BLOCK' }}
                  {{ icon = '‚ùå' }}
                  {{ status = '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞' }}
                  {{ CASE 'NOT PAID' }}
                  {{ icon = 'üí∞' }}
                  {{ status = '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã' }}
                  {{ CASE }}
                  {{ icon = '‚è≥' }}
                  {{ status = '–û–±—Ä–∞–±–æ—Ç–∫–∞' }}
                {{ END }}
                [
                    {
                        "text": "{{ item.name }} - {{ icon }} {{ status }}",
                        "callback_data": "/service {{ item.user_service_id }}"
                    }
                ],
                {{ END }}
                [
                    {
                        "text": "‚úö –ö—É–ø–∏—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á",
                        "callback_data": "/pricelist"
                    }
                ],
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/menu"
                    }
                ]
            ]
        }
    }
}
<% CASE '/service' %>
{{ us = user.services.list_for_api( 'usi', args.0 ) }}
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "sendMessage": {
        {{ SWITCH us.status }}
          {{ CASE 'ACTIVE' }}
          {{ icon = '‚úÖ' }}
          {{ status = '–†–∞–±–æ—Ç–∞–µ—Ç' }}
          {{ CASE 'BLOCK' }}
          {{ icon = '‚ùå' }}
          {{ status = '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞' }}
          {{ CASE 'NOT PAID' }}
          {{ icon = 'üí∞' }}
          {{ status = '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã' }}
          {{ CASE }}
          {{ icon = '‚è≥' }}
          {{ status = '–û–±—Ä–∞–±–æ—Ç–∫–∞' }}
        {{ END }}
        "text": "<b>–£—Å–ª—É–≥–∞</b>: {{ us.name }}{{ IF us.expire }}\n\n<b>–û–ø–ª–∞—á–µ–Ω–∞ –¥–æ</b>: {{ us.expire }}{{ END }}\n\n<b>–°—Ç–∞—Ç—É—Å</b>: {{ icon}} {{ status }}",
        "reply_markup" : {
            "inline_keyboard": [
                {{ IF us.status == 'ACTIVE' }}
                {{ subscription_url = storage.read('name','vpn_mrzb_' _ args.0 ).subscription_url }}

                {{ IF us.category.grep('^vpn-mz-').first }}
                {{ IF subscription_url.grep('^https:').first }}
                [
                    {
                        "text": "–ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è",
                        "web_app": {
                            "url": "{{ subscription_url }}"
                        }
                    }
                ],
                [
                    {
                        "text": "–ü–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É –ø–æ–¥–ø–∏—Å–∫–∏",
                        "callback_data": "/show_mz_keys {{ args.0 }}"
                    }
                ],
                {{ ELSE }}
                [
                    {
                        "text": "–û–®–ò–ë–ö–ê: –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ SSL –¥–ª—è Marzban",
                        "callback_data": "/menu"
                    }
                ],
                {{ END }}
                {{ ELSE }}
                [
                    {
                        "text": "üóù  –°–∫–∞—á–∞—Ç—å –∫–ª—é—á",
                        "callback_data": "/download_qr {{ args.0 }}"
                    },
                    {
                        "text": "üëÄ –ü–æ–∫–∞–∑–∞—Ç—å QR –∫–æ–¥",
                        "callback_data": "/show_qr {{ args.0 }}"
                    }
                ],
                {{ END }}

                {{ END }}
                {{ IF us.status == 'NOT PAID' || us.status == 'BLOCK' }}
                [
                    {
                        "text": "üí∞ –û–ø–ª–∞—Ç–∏—Ç—å",
                        "callback_data": "/balance"
                    }
                ],
                {{ END }}
                {{ IF us.status != 'PROGRESS' }}
                [
                    {
                        "text": "‚ùå –£–¥–∞–ª–∏—Ç—å –∫–ª—é—á",
                        "callback_data": "/delete {{ args.0 }}"
                    }
                ],
                {{ END }}
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/list"
                    }
                ]
            ]
        }
    }
}
<% CASE '/pricelist' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "sendMessage": {
        "text": "‚ò∑ –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –¥–ª—è –∑–∞–∫–∞–∑–∞",
        "reply_markup" : {
            "inline_keyboard": [
                {{ FOR item IN ref(service.api_price_list) }}
                [
                    {
                        "text": "{{ item.name }} - {{ item.cost }} —Ä—É–±/–º–µ—Å.",
                        "callback_data": "/serviceorder {{ item.service_id }}"
                    }
                ],
                {{ END }}
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/menu"
                    }
                ]
            ]
        }
    }
}
<% CASE '/serviceorder' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "shmServiceOrder": {
        "service_id": "{{ args.0 }}",
        "callback_data": "/list",
        "cb_not_enough_money": "/balance",
        "error": "–û–®–ò–ë–ö–ê"
    }
}
<% CASE '/download_qr' %>
{
    "uploadDocumentFromStorage": {
        "name": "vpn{{ args.0 }}",
        "filename": "vpn{{ args.0 }}.conf"
    }
}
<% CASE '/show_qr' %>
{
    "uploadPhotoFromStorage": {
        "name": "vpn{{ args.0 }}",
        "format": "qr_code_png"
    }
}
<% CASE '/delete' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "sendMessage": {
        "text": "ü§î <b>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏. –£—Å–ª—É–≥—É –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å!</b>",
        "reply_markup" : {
            "inline_keyboard": [
                [
                    {
                        "text": "üß® –î–ê, –£–î–ê–õ–ò–¢–¨! üî•",
                        "callback_data": "/delete_confirmed {{ args.0 }}"
                    }
                ],
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/list"
                    }
                ]
            ]
        }
    }
}
<% CASE '/delete_confirmed' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "shmServiceDelete": {
        "usi": "{{ args.0 }}",
        "callback_data": "/list",
        "error": "–û–®–ò–ë–ö–ê"
    }
}
<% CASE '/help' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "sendPhoto": {
        "photo": "https://media.tenor.com/5KHjsG1Aw1YAAAAi/photos-google-photos.gif",
        "protect_content": "true",
        "parse_mode":"HTML",
        "caption": "1Ô∏è‚É£  –°–∫–∞—á–∞–π—Ç–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ WireGuard –∫ —Å–µ–±–µ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ. –°–∫–∞—á–∞—Ç—å –¥–ª—è <a href=\"https://apps.apple.com/us/app/wireguard/id1441195209\">iPhone</a>, <a href=\"https://play.google.com/store/apps/details?id=com.wireguard.android\">Android</a>, <a href=\"https://apps.apple.com/us/app/wireguard/id1451685025\">Mac</a>.\n\n2Ô∏è‚É£ –í —Ä–∞–∑–¥–µ–ª–µ \"–ö–ª—é—á–∏\" –Ω–∞–∂–º–∏—Ç–µ \"–ù–æ–≤—ã–π –∫–ª—é—á\" –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π –≤–∞–º.\n\n3Ô∏è‚É£  –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Å–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è WireGuard. –ù–∞—Ö–æ–¥—è—Å—å –≤ –º–µ–Ω—é \"–ö–ª—é—á–∏\" –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π –∫–ª—é—á, –∫–ª–∏–∫–Ω—É–≤ –ø–æ –Ω–µ–º—É. –î–∞–ª–µ–µ —Å–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª –∫–ª—é—á–∞ –∏ –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ WireGuard.",
        "reply_markup" : {
            "inline_keyboard": [
                [
                    {
                        "text": "–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
                        "url": "https://t.me/shm_billing"
                    }
                ],
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/menu"
                    }
                ]
            ]
        }
    }
}
<% CASE '/pays' %>
{
    "sendMessage": {
        "text": "–ü–ª–∞—Ç–µ–∂–∏",
        "reply_markup" : {
            "inline_keyboard": [
                {{ FOR item IN ref(user.pays.list_for_api('limit', 5)) }}
                [
                    {
                        "text": "–î–∞—Ç–∞: {{ item.date }}, –°—É–º–º–∞: {{ item.money }} —Ä—É–±.",
                        "callback_data": "/menu"
                    }
                ],
                {{ END }}
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/menu"
                    }
                ]
            ]
        }
    }
}
<% CASE '/referrals' %>
{
    "sendMessage": {
        "text": "ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞\n\n–ü—Ä–∏–≤–æ–¥–∏ –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π {{ config.billing.partner.income_percent }}% —Å –∏—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π\n\n‚¨áÔ∏èÔ∏è –¢–≤–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n‚îî https://t.me/NAME_bot?start={{ user.id }}\n\nüèÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n‚îú –ü—Ä–∏–≤–µ–¥–µ–Ω–æ –¥—Ä—É–∑–µ–π: {{ user.referrals_count }}\n‚îî –î–æ—Å—Ç—É–ø–Ω–æ –∫ –≤—ã–≤–æ–¥—É: {{ user.get_bonus }} ‚ÇΩ",
        "reply_markup": {
            "inline_keyboard": [
                [
                    {
                        "text": "–ù–∞–∑–∞–¥...",
                        "callback_data": "/menu"
                    }
                ]
            ]
        }
    }
}
<% CASE '/show_mz_keys' %>
{{ subscription_url = storage.read('name','vpn_mrzb_' _ args.0 ).subscription_url }}
{
    "printQrCode": {
        "data": "{{ subscription_url }}",
        "parameters": {
            "parse_mode": "HTML",
            "caption": "<b>Subscription URL:</b>\n<code>{{ subscription_url }}</code>"
        }
    }
},
{{ ss = storage.read('name','vpn_mrzb_' _ args.0 ).links.grep('^ss:').first }}
{
    "printQrCode": {
        "data": "{{ ss }}",
        "parameters": {
            "parse_mode": "HTML",
            "caption": "<b>ShadowSocks:</b>\n<code>{{ ss }}</code>"
        }
    }
},
{{ vless_tcp = storage.read('name','vpn_mrzb_' _ args.0 ).links.grep('^vless:').first }}
{
    "printQrCode": {
        "data": "{{ vless_tcp }}",
        "parameters": {
            "parse_mode": "HTML",
            "caption": "<b>VLESS TCP:</b>\n<code>{{ vless_tcp }}</code>"
        }
    }
},
{{ vless_grpc = storage.read('name','vpn_mrzb_' _ args.0 ).links.grep('^vless:').last }}
{
    "printQrCode": {
        "data": "{{ vless_grpc }}",
        "parameters": {
            "parse_mode": "HTML",
            "caption": "<b>VLESS GRPC:</b>\n<code>{{ vless_grpc }}</code>"
        }
    }
}
<% END %>
